<!--
 Copyright 2022 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <title>AI Learning Tools - Content Selection</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #1f2937;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 24px;
            height: 24px;
            display: inline-block;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tool-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            background: white;
        }

        .tool-card:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.1);
        }

        .tool-card.selected {
            border-color: #4f46e5;
            background: #f8faff;
            box-shadow: 0 0 0 1px #4f46e5;
        }

        .tool-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .tool-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .tool-info h3 {
            color: #1f2937;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .tool-info .badge {
            background: #ddd6fe;
            color: #5b21b6;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .tool-description {
            color: #6b7280;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .tool-features {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .feature-tag {
            background: #f3f4f6;
            color: #374151;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            background: white;
            transition: all 0.2s ease;
        }

        .tool-card.selected .checkbox {
            background: #4f46e5;
            border-color: #4f46e5;
        }

        .tool-card.selected .checkbox::after {
            content: '‚úì';
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .configuration {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .config-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .courses-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            background: white;
        }

        .course-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .course-item:hover {
            background-color: #f9fafb;
        }

        .course-item:last-child {
            border-bottom: none;
        }

        .course-item.selected {
            background-color: #f0f9ff;
            border-left: 4px solid #4f46e5;
        }

        .course-info h4 {
            margin: 0;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .course-info p {
            margin: 2px 0 0 0;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .course-status {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .course-status.active {
            background: #dcfce7;
            color: #166534;
        }

        .course-status.inactive {
            background: #fef2f2;
            color: #dc2626;
        }

        .loading-courses {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 20px;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-group label {
            color: #374151;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px #4f46e5;
        }

        .system-prompt-textarea {
            width: 100%;
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        .system-prompt-textarea::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px 40px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }

        .selected-count {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .button-group {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            border: none;
            font-size: 14px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);
        }

        .btn-primary:disabled {
            background: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            color: #6b7280;
            font-style: italic;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
        }

        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 12px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .content {
                padding: 20px;
            }

            .tools-grid {
                grid-template-columns: 1fr;
            }

            .config-row {
                grid-template-columns: 1fr;
            }

            .actions {
                flex-direction: column;
                gap: 15px;
            }

            .button-group {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <!-- Hidden data elements for JavaScript -->
    <script type="application/json" id="launch-data">{{ launch_data | tojson | default('{}') | safe }}</script>
    <script type="application/json"
        id="deep-link-settings">{{ deep_link_settings | tojson | default('{}') | safe }}</script>

    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Learning Tools</h1>
            <p>Select an AI service and course for your LTI tool</p>
        </div>

        <div class="content">
            <div class="section">
                <h2>
                    <span class="icon">üìö</span>
                    Step 1: Choose AI Service
                </h2>

                <div class="tools-grid">
                    <div class="tool-card" data-tool="lecture_assistant">
                        <div class="checkbox"></div>
                        <div class="tool-header">
                            <div class="tool-icon">üéì</div>
                            <div class="tool-info">
                                <h3>AI Assistant (Chat)</h3>
                                <span class="badge">Interactive</span>
                            </div>
                        </div>
                        <div class="tool-description">
                            Interactive AI-powered assistant for enhanced learning. Students can ask questions, get
                            explanations, and receive personalized guidance throughout their learning journey.
                        </div>
                        <div class="tool-features">
                            <span class="feature-tag">üí¨ Chat Interface</span>
                            <span class="feature-tag">‚≠ê Adaptive Learning</span>
                        </div>
                    </div>

                    <div class="tool-card" data-tool="quiz_generator">
                        <div class="checkbox"></div>
                        <div class="tool-header">
                            <div class="tool-icon">‚ùì</div>
                            <div class="tool-info">
                                <h3>Quiz Generator</h3>
                                <span class="badge">Assessment</span>
                            </div>
                        </div>
                        <div class="tool-description">
                            Generate comprehensive quiz questions and assessments from course content. Create multiple
                            choice, short answer, and essay questions with AI assistance.
                        </div>
                        <div class="tool-features">
                            <span class="feature-tag">üîÑ Auto Generation</span>
                            <span class="feature-tag">üìù Multiple Formats</span>
                            <span class="feature-tag">ü§ñ AI Powered</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>
                    <span class="icon">üìñ</span>
                    Step 2: Select Course
                </h2>

                <div class="configuration">
                    <div class="form-group">
                        <label>Select a Course for this Tool</label>
                        <small style="color: #6b7280; margin-bottom: 10px; display: block;">
                            Click on a course below to select it for your AI service
                        </small>
                        <div id="courses_list" class="courses-list">
                            <div class="loading-courses">Loading courses for this group...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Prompt Configuration (only for AI Assistant) -->
            <div class="section" id="system-prompt-section" style="display: none;">
                <h2>
                    <span class="icon">ü§ñ</span>
                    Step 3: Configure AI Assistant
                </h2>

                <div class="configuration">
                    <div class="form-group">
                        <label for="system-prompt">System Prompt (Optional)</label>
                        <small style="color: #6b7280; margin-bottom: 10px; display: block;">
                            Define how the AI Assistant should behave and respond to students. This will guide its
                            personality and expertise.
                        </small>
                        <textarea id="system-prompt" class="system-prompt-textarea" rows="6"></textarea>
                    </div>
                </div>
            </div>

            <div class="error" id="error-message"></div>
            <div class="success" id="success-message"></div>
            <div class="loading" id="loading-message">Creating your AI learning tool...</div>
        </div>

        <div class="actions">
            <div class="selected-count" id="selected-count">No service selected</div>
            <button class="btn btn-primary" id="create-tools" disabled onclick="createTools()">
                <span class="icon">‚ú®</span>
                Create LTI Tool
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let selectedTools = new Set();
        let selectedCourseId = null;
        const ltiSessionToken = "{{ lti_session_token }}";
        const backendDomainName = "{{ backend_domain_name }}";
        const baseUrl = "https://" + backendDomainName;

        const defaultSystemPrompt = "You are a helpful AI teaching assistant. You should provide clear, educational responses that encourage student learning.";
        document.getElementById('system-prompt').value = defaultSystemPrompt;

        // Parse data from hidden script elements
        let launchData, deepLinkSettings;
        try {
            launchData = JSON.parse(document.getElementById('launch-data').textContent || '{}');
        } catch (e) {
            launchData = {};
        }

        try {
            deepLinkSettings = JSON.parse(document.getElementById('deep-link-settings').textContent || '{}');
        } catch (e) {
            deepLinkSettings = {};
        }

        console.log('Deep link return URL:', deepLinkSettings.deep_link_return_url);

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            initializeToolSelection();
            updateSelectedCount();
            loadCourses();

            // Pre-select lecture_assistant by default
            const defaultTool = document.querySelector('[data-tool="lecture_assistant"]');
            if (defaultTool) {
                selectTool('lecture_assistant');
            }
        });

        // Course loading functionality
        async function loadCourses() {
            try {
                const response = await fetch(`${baseUrl}/lti/deep_link/courses`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${ltiSessionToken}`
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                displayCourses(data.courses);

            } catch (error) {
                console.error('Error loading courses:', error);
                document.getElementById('courses_list').innerHTML =
                    '<div class="loading-courses">Error loading courses. Please try again.</div>';
            }
        }

        function displayCourses(courses) {
            const coursesList = document.getElementById('courses_list');

            if (courses.length === 0) {
                coursesList.innerHTML = '<div class="loading-courses">No courses available for this group.</div>';
                return;
            }

            // Sort courses alphabetically by title
            const sortedCourses = courses.sort((a, b) => a.title.localeCompare(b.title));

            const coursesHtml = sortedCourses.map(course => `
                <div class="course-item" onclick="selectCourse('${course.id}')">
                    <div class="course-info">
                        <h4>${course.title}</h4>
                        <p>Course ID: ${course.id}</p>
                    </div>
                    <div class="course-status ${course.status}">${course.status}</div>
                </div>
            `).join('');

            coursesList.innerHTML = coursesHtml;
        }

        function selectCourse(courseId) {
            // Update selected course ID
            selectedCourseId = courseId;

            // Remove selection from all course items
            document.querySelectorAll('.course-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selection to clicked course item
            const selectedItem = document.querySelector(`[onclick="selectCourse('${courseId}')"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }

            updateCreateButton();
            updateSelectedCount();
        }

        function initializeToolSelection() {
            const toolCards = document.querySelectorAll('.tool-card');

            toolCards.forEach(card => {
                card.addEventListener('click', function () {
                    const toolType = this.dataset.tool;
                    toggleTool(toolType);
                });
            });
        }

        function toggleTool(toolType) {
            if (selectedTools.has(toolType)) {
                deselectTool(toolType);
            } else {
                // Clear all other selections first (only allow one selection)
                selectedTools.clear();
                document.querySelectorAll('.tool-card').forEach(card => {
                    card.classList.remove('selected');
                });
                selectTool(toolType);
            }
        }

        function selectTool(toolType) {
            selectedTools.add(toolType);
            const card = document.querySelector(`[data-tool="${toolType}"]`);
            if (card) {
                card.classList.add('selected');
            }
            updateSystemPromptVisibility();
            updateSelectedCount();
            updateCreateButton();
        }

        function deselectTool(toolType) {
            selectedTools.delete(toolType);
            const card = document.querySelector(`[data-tool="${toolType}"]`);
            if (card) {
                card.classList.remove('selected');
            }
            updateSystemPromptVisibility();
            updateSelectedCount();
            updateCreateButton();
        }

        function updateSystemPromptVisibility() {
            const systemPromptSection = document.getElementById('system-prompt-section');
            const isAIAssistantSelected = selectedTools.has('lecture_assistant');

            if (isAIAssistantSelected) {
                systemPromptSection.style.display = 'block';
            } else {
                systemPromptSection.style.display = 'none';
                // Reset the system prompt when hiding the section
                const systemPromptInput = document.getElementById('system-prompt');
                if (systemPromptInput) {
                    systemPromptInput.value = defaultSystemPrompt;
                }
            }
        }

        function updateSelectedCount() {
            const count = selectedTools.size;
            const countElement = document.getElementById('selected-count');

            if (count === 0) {
                countElement.textContent = 'No service selected';
            } else {
                const selectedTool = Array.from(selectedTools)[0];
                const toolName = selectedTool === 'lecture_assistant' ? 'AI Assistant (Chat)' : 'Quiz Generator';
                if (selectedCourseId) {
                    countElement.textContent = `${toolName} + Course selected`;
                } else {
                    countElement.textContent = `${toolName} selected (choose course)`;
                }
            }
        }

        function updateCreateButton() {
            const createButton = document.getElementById('create-tools');
            createButton.disabled = selectedTools.size === 0 || !selectedCourseId;
        }

        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';

            // Hide after 5 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successElement = document.getElementById('success-message');
            successElement.textContent = message;
            successElement.style.display = 'block';
        }

        function showLoading(show = true) {
            const loadingElement = document.getElementById('loading-message');
            const createButton = document.getElementById('create-tools');

            loadingElement.style.display = show ? 'block' : 'none';
            createButton.disabled = show || selectedTools.size === 0 || !selectedCourseId;

            if (show) {
                createButton.textContent = 'Creating...';
            } else {
                createButton.innerHTML = '<span class="icon">‚ú®</span> Create LTI Tool';
            }
        }

        async function createTools() {
            if (selectedTools.size === 0) {
                showError('Please select a service to create.');
                return;
            }

            if (!selectedCourseId) {
                showError('Please select a course before creating the service.');
                return;
            }

            showLoading(true);

            try {
                // Get the selected service type
                const selectedServiceType = Array.from(selectedTools)[0];

                // Get system prompt if AI Assistant is selected
                const systemPromptInput = document.getElementById('system-prompt');
                const systemPrompt = systemPromptInput ? systemPromptInput.value.trim() : '';

                // Gather configuration including LTI Deep Linking data
                const config = {
                    resource_types: Array.from(selectedTools),
                    custom_params: {
                        service_type: selectedServiceType,  // Add the service type to custom_params
                        course_id: selectedCourseId || launchData.course_id || 'default-course',
                        features: getSelectedFeatures()
                    },
                    // LTI Deep Linking spec: Include the data field from deep_link_settings
                    deep_link_data: deepLinkSettings.data,
                    return_url: deepLinkSettings.deep_link_return_url
                };

                // Add system prompt to custom_params if AI Assistant is selected
                if (selectedServiceType === 'lecture_assistant') {
                    config.custom_params.system_prompt = systemPrompt;
                }

                console.log('Creating tools with config:', config);
                console.log('Custom params:', config.custom_params);

                // Get launch_id from deep link data if available (following Flask example pattern)
                let launch_id = '';
                try {
                    if (deepLinkSettings.data) {
                        const parts = deepLinkSettings.data.split('|');
                        const encodedData = parts[parts.length - 1];
                        const decodedData = JSON.parse(atob(encodedData));
                        launch_id = decodedData.launch_id || '';
                        console.log('Found launch_id in deep link data:', launch_id);
                    }
                } catch (e) {
                    console.warn('Could not extract launch_id from deep link data:', e);
                }

                const endpoint = `${baseUrl}/lti/deep_link${launch_id ? '?launch_id=' + encodeURIComponent(launch_id) : ''}`;
                console.log('Using endpoint:', endpoint);

                // Make API call to create tool
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${ltiSessionToken}`
                    },
                    credentials: 'include',
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                // Check if response is HTML (deep linking auto-submit form) or JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('text/html')) {
                    // This is a deep linking response - get the HTML and inject it
                    const htmlContent = await response.text();
                    console.log('Received deep linking HTML response');

                    // Create a temporary container and inject the form
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlContent;

                    // Find the form and submit it immediately
                    const form = tempDiv.querySelector('form');
                    if (form) {
                        document.body.appendChild(form);
                        console.log('Auto-submitting deep linking form back to LMS');
                        form.submit();
                    } else {
                        throw new Error('No form found in deep linking response');
                    }
                } else {
                    // This is a JSON response (for UI testing)
                    const result = await response.json();
                    console.log('Tool creation response:', result);

                    showSuccess(result.message || 'Successfully created AI learning tool!');

                    // Send result back to LMS
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'tool_creation_response',
                            data: result
                        }, '*');
                    }
                }

            } catch (error) {
                console.error('Error creating tools:', error);
                showError(`Failed to create tools: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function getSelectedFeatures() {
            const features = [];

            selectedTools.forEach(tool => {
                switch (tool) {
                    case 'lecture_assistant':
                        features.push('chat', 'voice', 'analytics', 'adaptive');
                        break;
                    case 'quiz_generator':
                        features.push('auto_generation', 'multiple_formats', 'auto_grading', 'analytics');
                        break;
                }
            });

            return [...new Set(features)]; // Remove duplicates
        }
    </script>
</body>

</html>